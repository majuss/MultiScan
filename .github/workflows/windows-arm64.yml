name: Build Windows (arm64)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"
  release:
    types: [published]

jobs:
  build-windows-arm64:
    runs-on: windows-11-arm
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter (stable, arm64)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          git clone https://github.com/flutter/flutter.git -b stable --depth 1 "$env:USERPROFILE\flutter"
          "$env:USERPROFILE\flutter\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify Flutter
        run: flutter --version

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Windows release (arm64)
        run: flutter build windows --release

      - name: Package build output
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $outDir = "build\windows\artifacts"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          $releaseDir = Get-ChildItem -Path "build\windows" -Recurse -Directory |
            Where-Object { Test-Path (Join-Path $_.FullName "MultiScan.exe") } |
            Select-Object -First 1

          if (-not $releaseDir) {
            throw "Could not locate Windows release folder containing MultiScan.exe under build\windows."
          }

          $zipPath = Join-Path $outDir "multiscan-windows-arm64.zip"
          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }

          Compress-Archive -Path (Join-Path $releaseDir.FullName "*") -DestinationPath $zipPath
          Write-Host "Created $zipPath"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: multiscan-windows-arm64
          path: build/windows/artifacts/multiscan-windows-arm64.zip
          if-no-files-found: error
